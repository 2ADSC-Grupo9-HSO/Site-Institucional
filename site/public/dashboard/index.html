<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="main.js"></script>
    <link rel="icon" href="../assets/icons/icone_head.ico" />
    <title>Document</title>
</head>

<body onload="init_time()">
    <section class="navgator temporaria teste">
        <div class="logo">
            <img class="logo" src="../assets/imgs/logo-removebg-preview.png" alt="">
        </div>
        <div class="container_botão">
            <div class="teste1">
                <a class="link" href="../cadastro_maquina.html">
                    <div class="adicionar maquina">Adicionar máquina
                        <div class="iconePlus"><img class="botao_adicionar" ; href="" ;
                                src="../assets/imgs/botao-adicionar.png">
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <div class="menu">
            <span class="texto_hover">Dashboard</span>
            <span class="texto_hover">Apontamentos</span>
            <span class="texto_hover">Usuários</span>
            <div class="div_espacamento"></div>
            <span class="texto_hover"><a class="link" href="../index.html">Sair</a></span>
        </div>
    </section>
    <section class="temporaria principal">
        <div class="temporaria barra-principal">
            <div class="search-container">
                <label for="search-input" class="search-icon"></label>
                <input type="text" class="search-input" id="search-input" required />
            </div>
            <div class="div_hora">
                <div class="relogio_icon"><img class="relogio_icon" src="../assets/imgs/relogio.png" alt="">
                </div>
                <span id="timer"></span>
            </div>
            <div class="div_user">
                <img class="user_icon" src="../assets/imgs/user.png" alt="">
            </div>
        </div>
        <div class="temporaria conteudo">
            <div class="temporaria pacientes">
                <div class="icone_usuarios">
                    <div class="conteudo_icones">
                        <div class="div_user">
                            <img class="user_icon" src="../assets/imgs/user.png" alt="">
                            <span class="texto">Carlos</span>
                        </div>
                        <div class="div_user">
                            <img class="user_icon" src="../assets/imgs/user2.png" alt="">
                            <span class="texto">Maria</span>
                        </div>
                        <div class="div_user">
                            <img class="user_icon" src="../assets/imgs/user3.png" alt="">
                            <span class="texto">Arthur</span>
                        </div>
                        <div class="div_user">
                            <img class="user_icon" src="../assets/imgs/user4.png" alt="">
                            <span class="texto">Angelo</span>
                        </div>
                    </div>
                </div>
                <div class="grafico_1">
                    <span style="color: white;">Quantidade de maquinas Debilitadas</span>
                    <div class="container_graficoDonut">
                        <div id="grafico_donut" class="grafico_Donut">
                            <!-- <canvas id="myChartDonut"></canvas> -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="temporaria requests">

                <div class="grafico_3">
                    <span style="color: white;"> Maquinas Totais com Problemas </span>
                    <div class="container_grafico">
                        <div id="grafico_atividade" class="grafico_atividade">
                            <!--                             <canvas id="myChartAtividade"></canvas>
 -->
                        </div>
                    </div>
                </div>
            </div>
            <div id="temporaria_apontamento" class="temporaria apontamento">
                <div class="apontamentos_atuais">
                    <div class="espacamentos"></div>
                    <div class="texto posicao">Apontamento atual</div>
                    <div class="div_hoje texto">Hoje</div>
                </div>

                <div class="modal">
                    <div class="conteudoModal">
                        <div class="nomeModal">
                            <h3 id="nomeModalMaquina"></h3>
                            <img onclick="fecharModal()" src="xis">
                        </div>
                        <div class="graficoModal">
                            <div class="graficoMaquina" id="graficoMaquina">
                            </div>
                            <div class="execMaquina">
                                <button>Listar Processos</button>
                                <button>Reiniciar Maquina</button>
                                <button>Matar 5 processos</button>
                            </div>
                        </div>
                        <div class="infoModal">
                            <div class="infoMaquina" id="infoRede"></div>
                            <div class="infoMaquina" id="infoAndar"></div>
                            <div class="infoMaquina" id="infoMarca"></div>
                            <div class="infoMaquina" id="infoSistema"></div>
                            <div class="infoMaquina" id="infoQtdProblema"></div>
                        </div>
                    </div>
                </div>
</body>

</html>
<script>
    criar_card();
    gerar_graficos();



    function show_time() {
        let time = new Date();
        let hour = time.getHours();
        let minute = time.getMinutes();
        let second = time.getSeconds();

        if (hour < 10) hour = "0" + hour;
        if (minute < 10) minute = "0" + minute;
        if (second < 10) second = "0" + second;

        var tempo = hour + ":" + minute + ":" + second;
        document.getElementById("timer").innerHTML = tempo;
    }
    function init_time() {
        setInterval(show_time, 1000);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>

    let proximaAtualizacao;

    function obterDadosGrafico(idMaquina) {

        clearTimeout(proximaAtualizacao);

        var isCreated = document.getElementById("graficoModal")
        var divGraficoModal = document.getElementById("graficoMaquina")

        if (isCreated != null) {
            var varGraficoModal = document.getElementById("graficoModal")
            divGraficoModal.removeChild(varGraficoModal)
            clearTimeout(proximaAtualizacao)
        }

        var varGraficoModal = document.createElement("canvas")
        divGraficoModal.append(varGraficoModal)
        varGraficoModal.id = "graficoModal"

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log(idMaquina)
                    resposta.reverse();

                    plotarGrafico(resposta, idMaquina);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idMaquina) {
        console.log('iniciando plotagem do gráfico...');

        let labels = [];

        let dados = {
            labels: labels,
            datasets: [{
                label: 'Disco',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },
            {
                label: 'Processador',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                tension: 0.1
            },
            {
                label: 'Memoria RAM',
                data: [],
                fill: false,
                borderColor: 'rgb(255, 72, 92)',
                tension: 0.1
            }]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            if ((i + 1) % 3 == 0) {
                labels.push(registro.momento);
            }
            if (registro.nomeComponente == "Memória Ram") {
                dados.datasets[0].data.push(registro.registro);
            } else if (registro.nomeComponente == "Processador") {
                dados.datasets[1].data.push(registro.registro);
            } else if (registro.nomeComponente == "Disco") {
                dados.datasets[2].data.push(registro.registro);
            }
        }
        const config = {
            type: 'line',
            data: dados,
        };

        let myChart = new Chart(
            document.getElementById('graficoModal'),
            config
        );

        setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 500);
    }

    function atualizarGrafico(idMaquina, dados, myChart) {

        fetch(`/medidas/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    if (novoRegistro[0].momento == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].registro);

                        dados.datasets[1].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[1].data.push(novoRegistro[1].registro); // incluir uma nova medida de umidade

                        dados.datasets[2].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[2].data.push(novoRegistro[2].registro); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 500);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 500);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }



</script>